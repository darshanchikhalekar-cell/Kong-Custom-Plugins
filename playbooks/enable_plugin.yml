---
- name: Enable Kong Custom Plugin
  hosts: all
  gather_facts: false

  vars:
    # Default Kong Admin API URL
    kong_admin_url: http://127.0.0.1:8001

  tasks:

    - name: Validate plugin name
      fail:
        msg: "plugin_name is required"
      when: plugin_name is not defined or plugin_name | length == 0

    - name: Check if plugin already enabled
      command: >
        curl -s {{ kong_admin_url }}/plugins
      register: plugins_list
      changed_when: false

    - name: Enable plugin if not already enabled
      command: >
        curl -s -X POST {{ kong_admin_url }}/plugins
        -d "name={{ plugin_name }}"
      when: plugin_name not in plugins_list.stdout
      register: enable_output
      changed_when: "'id' in enable_output.stdout"

    - name: Plugin enable status
      debug:
        msg: "Plugin {{ plugin_name }} is enabled"
