---
- name: Enable Kong Custom Plugin
  hosts: all
  gather_facts: false
  become: false

  vars:
    kong_admin_url: http://localhost:8001

  tasks:

    # ============================================================
    # NORMALIZE INPUTS
    # ============================================================
    - name: Normalize survey inputs
      set_fact:
        deploy_scope: "{{ deploy_scope | default('global') }}"
        kong_service_name: "{{ kong_service_name | default('') }}"

    # ============================================================
    # VALIDATION
    # ============================================================
    - name: Validate plugin name
      assert:
        that:
          - plugin_name is defined
          - plugin_name | length > 0
        fail_msg: "plugin_name must be provided"

    - name: Validate headers for static-response-header plugin
      fail:
        msg: "header_key and header_value are required for static-response-header plugin"
      when:
        - plugin_name == "static-response-header"
        - header_key is not defined or header_key | trim == "" or
          header_value is not defined or header_value | trim == ""

    - name: Validate service name when scope is service
      fail:
        msg: "kong_service_name is required when deployment scope is 'service'"
      when:
        - deploy_scope == "service"
        - kong_service_name | trim == ""

    # ============================================================
    # ENABLE PLUGIN
    # ============================================================
    - name: Enable plugin globally
      uri:
        url: "{{ kong_admin_url }}/plugins"
        method: POST
        body_format: form-urlencoded
        body:
          name: "{{ plugin_name }}"
          config.headers.{{ header_key }}: "{{ header_value }}"
        status_code: [201, 409]
      when: deploy_scope == "global"

    - name: Enable plugin on selected service
      uri:
        url: "{{ kong_admin_url }}/services/{{ kong_service_name }}/plugins"
        method: POST
        body_format: form-urlencoded
        body:
          name: "{{ plugin_name }}"
          config.headers.{{ header_key }}: "{{ header_value }}"
        status_code: [201, 409]
      when: deploy_scope == "service"

    # ============================================================
    # POST ENABLE INFO
    # ============================================================
    - name: Show enable summary
      debug:
        msg: |
          =====================================
          KONG PLUGIN ENABLED
          =====================================
          Plugin Name : {{ plugin_name }}
          Scope       : {{ deploy_scope }}
          Service     : {{ kong_service_name | default('N/A') }}
          Header      : {{ header_key }}={{ header_value }}
          Host        : {{ inventory_hostname }}
          =====================================
