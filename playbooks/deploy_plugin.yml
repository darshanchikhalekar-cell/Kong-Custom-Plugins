---
- name: Deploy Kong Custom Plugin
  hosts: all
  become: true
  gather_facts: false

  vars:
    kong_conf: /etc/kong/kong.conf
    kong_plugin_base: /usr/local/share/lua/5.1/kong/plugins

  tasks:

    # ============================================================
    # VALIDATION
    # ============================================================
    - name: Validate plugin name from workflow survey
      assert:
        that:
          - plugin_name is defined
          - plugin_name | length > 0
        fail_msg: "plugin_name must be provided in AWX workflow survey"

    # ============================================================
    # DEPLOY PLUGIN FILES
    # ============================================================
    - name: Ensure plugin directory exists
      file:
        path: "{{ kong_plugin_base }}/{{ plugin_name }}"
        state: directory
        owner: kong
        group: kong
        mode: '0755'

    - name: Copy plugin files to Kong
      copy:
        src: "../plugins/{{ plugin_name }}/"
        dest: "{{ kong_plugin_base }}/{{ plugin_name }}/"
        owner: kong
        group: kong
        mode: '0644'
      register: plugin_copy

    - name: Verify handler.lua exists
      stat:
        path: "{{ kong_plugin_base }}/{{ plugin_name }}/handler.lua"
      register: handler_check

    - name: Fail if handler.lua is missing
      fail:
        msg: "handler.lua not found for plugin {{ plugin_name }}"
      when: not handler_check.stat.exists

    # ============================================================
    # SAFE PLUGIN LIST MERGE
    # ============================================================
    - name: Read current plugins list (last occurrence)
      shell: |
        grep '^plugins' {{ kong_conf }} | tail -n 1 | cut -d= -f2
      register: current_plugins
      changed_when: false
      failed_when: false

    - name: Build merged plugin list
      set_fact:
        merged_plugins: >-
          {{
            (
              (current_plugins.stdout | default('bundled'))
              .split(',')
              + [ plugin_name ]
            )
            | map('trim')
            | unique
            | join(',')
          }}

    - name: Remove ALL existing plugins lines
      replace:
        path: "{{ kong_conf }}"
        regexp: '^plugins\s*=.*$'
        replace: ''

    - name: Write single merged plugins line
      lineinfile:
        path: "{{ kong_conf }}"
        line: "plugins = {{ merged_plugins }}"
        insertafter: '^#plugins'
      register: plugin_conf_update

    # ============================================================
    # SAFE KONG RESTART (ONLY IF NEEDED)
    # ============================================================
    - name: Stop Kong safely
      command: kong stop
      ignore_errors: true
      when: plugin_copy.changed or plugin_conf_update.changed

    - name: Remove dangling Kong sockets
      file:
        path: /usr/local/kong/sockets
        state: absent
      when: plugin_copy.changed or plugin_conf_update.changed

    - name: Start Kong
      command: kong start
      when: plugin_copy.changed or plugin_conf_update.changed

    - name: Verify Kong health
      command: kong health
      register: kong_health
      retries: 5
      delay: 5
      until: kong_health.rc == 0
      when: plugin_copy.changed or plugin_conf_update.changed

    # ============================================================
    # POST DEPLOY INFO
    # ============================================================
    - name: Show deploy summary
      debug:
        msg: |
          =====================================
          KONG PLUGIN DEPLOYED
          =====================================
          Plugin Name : {{ plugin_name }}
          Host        : {{ inventory_hostname }}
          Plugins     : {{ merged_plugins }}
          Restarted   : {{ plugin_copy.changed or plugin_conf_update.changed }}
          =====================================
